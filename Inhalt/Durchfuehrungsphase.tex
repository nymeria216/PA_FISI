% !TEX root = ../Projektdokumentation.tex
\section{Projektdurchführung} 
\label{sec:Projektdurchführung}

\subsection{Vorbereitung der Entwicklungsumgebung}
\label{sec:Vorbereitung der Entwicklungsumgebung}
Die Voraussetzung zur Implementierung von Authentik ist, dass Docker und Docker Compose auf dem im Kapitel \ref{sec:Sachmittelplanung} 
\nameref{sec:Sachmittelplanung} erwähnten Notebook vorinstalliert sind und einen Zugang zum Internet verfügen. Des Weiteren sollten die zu 
benötigenden Hard- und Softwarekomponenten, welche ebenfalls in der \nameref{sec:Sachmittelplanung} auf der Seit \pageref{sec:Sachmittelplanung} 
gelistet sind, funktionierend sein. Wichtig für die Durchführung ist nicht nur Docker mit dem Notebook selbst, sondern auch der 
Besitz einer Domain oder Subdomain, welche bei der Deloitte Wirtschaftsprüfungsgesellschaft GmbH, die \textbf{tal.deloitte.de} ist. 
Diese muss entweder mit einem A- oder CNAME-Record versehen sein. Um die Domain-Names übersichtlich verwalten zu können, 
empfiehlt sich ein Reverse Proxy, in diesem Fall wird es auf den NGinx Proxy Manager zurückzuführen sein. Und zu guter letzt einen SMTP 
E-Mail Server zur beispielsweise Zurücksetzung eines Passworts. Für das Testen der kommenden Schritte im Kapitel 
\ref{sec:Konfiguration des zweiten Faktors} \nameref{sec:Konfiguration des zweiten Faktors} ab der Seite 
\pageref{sec:Konfiguration des zweiten Faktors} wird das iPhone 12, erwähnt in der \nameref{sec:Sachmittelplanung}, verwendet. 
Dieses mobile Endgerät ist ein Firmentelefon und beinhaltet zusätzlich den Microsoft Authenticator, um sich 
gewissermaßen remote mit dem VPN des Firmennetzwerkes verbinden zu können. Aus diesem Grund muss kein weiteres Active Directory 
installiert und eingerichtet werden.

\subsection{Auswahl einer MFA-Lösung}
\label{sec:Auswahl einer MFA-Lösung}
Bei Authentik werden die drei Optionen \textbf{WebAuthn Authenticator Setup Stage}, \textbf{Static Authenticator Stage} und 
\textbf{\acs{TOTP} Authenticator Setup Stage} angeboten. 
\\Das Ergebnis der Tabelle \ref*{tab:Nutzwertanalyse} \nameref{tab:Nutzwertanalyse} ist nicht eindeutig zuordbar, bedingt dessen, dass 
die Optionen WebAuthn Authenticator Setup Stage und \acs{TOTP} Authenticator Setup Stage um 0,05 Wertungspunkte auseinander liegen und 
die Entscheidung des finalen Ergebnisses nicht anhand der \nameref{tab:Nutzwertanalyse} manifestierend festzulegen ist.
\tabelle{Nutzwertanalyse zur MFA-Lösung}{tab:Nutzwertanalyse}{Nutzwertanalyse_MFA.tex}
\\Die Entscheidungstreffung erfolgte besonders auf der Prämisse, dass die Deloitte Wirtschaftsprüfungsgesellschaft GmbH das \acs{TOTP}-Verfahren, 
quasi die Eingabe eines Einmalpassworts durch einen Authenticator, wie das iPhone 12, gestellt durch die Deloitte, bei allen zur Verfügung 
stehenden Services verwendet. So fiel die Entscheidung auf das \textbf{\acs{TOTP}-Verfahren}, was hingegen zum WebAuth Authenticator 
Setup Stage weniger Sicherheit aber weniger Implementierungsaufwand erfordert und kein weiteres Gerät oder eine weitere Datei oder Software 
notwendig ist, um die in der zu entstehenden hardwarebasierten Token zu verwalten. In dem \acs{TOTP} Authenticator Setup Stage geben die 
Entwickler :innen alle zu Beginn ihren Nutzernamen und das zugehörige Passwort ein. Nach einer erfolgreichen Anmeldung, werden die 
Entwickler :innen weitergeleitet, um ihren 6-stelligen Zahlencode, der in dem Microsoft Authenticator für 30 Sekunden sichtbar ist, einzugeben. 
Wenn die Entwicker :innen sich noch nicht über Authentik angemeldet hatten, werden diese nach der Anmeldung mit einem QR-Code gepromptet und 
daraufhin aufgefordert den 6-stelligen Code einzugeben.


\subsection{Erstellung der docker-compose.yml, .env}
\label{sec:Erstellung der docker-compose.yml, .env}
Um Authentik über eine ''\nameref{app:docker-compose.yml}''-Datei im \nameref{sec:Anhang} des Kapitels \ref{app:docker-compose.yml} 
zum Laufen zu bringen, ist es erforderlich, dass nicht nur der Authenik-Server, sondern auch der Authentik-Worker, 
Redis und PostgreSQL gleichzeitig erstellt werden. PostgreSQL ist eine objektrelationale Datenbank und unterstützt 
die Erweiter- und Skalierbarkeit der Cloud-Infrastruktur. Redis hingegen ist ein In-Memory-Datenspeicher, der als 
schneller Datenspeicher dient. Die ''\nameref{app:dotenv}''-Datei im Kapitel \ref{app:dotenv} \nameref{app:dotenv} 
enthält die individuellen Umgebungsvariablen für die Zugangsdaten der Nutzer :innen. 
\\Beide Dateien werden in einem Ordner ''Authentik'' auf der Instanz \textbf{''tal\_cloud\_infra''} durch docker erstellt. 
Eine Darstellung der Instanzen befindet sich im Kapitel \ref{app:Cloud-Infrastruktur} \nameref{app:Cloud-Infrastruktur}  auf der Seite 
\pageref{app:Cloud-Infrastruktur}. Die ''\nameref{app:docker-compose.yml}''-Datei wurde über \href{https://www.composerize.com/}{Composerize}, einer 
Applikation aus dem Internet entnommen, welche öffentlich zugänglich ist. Auch die ''\nameref{app:dotenv}''-Datei ist öffentlich über die 
Webpage von \href{https://goauthentik.io/}{Authentik} einsehbar. Die einzigen in dieser Datei vorzunehmenden Änderungen, sind die Variablen: 
''PG\_PASS'', ''AUTHENTIK\_SECRET\_KEY'', ''AUTHENTIK\_EMAIL\_\_HOST'', ''AUTHENTIK\_EMAIL\_\_USERNAME'', sowie ''AUTHENTIK\_EMAIL\_\_PASSWORD'' 
und ''AUTHENTIK\_EMAIL\_\_FROM''. Um Authentik zu starten, werden beide Dateien im Unterordner Authentik eingefügt. Nun wird mit dem Befehl 
\textbf{docker-compose pull} in Docker Compose die \textbf{\nameref{app:docker-compose.yml}} mit deren enthaltenen Diensten heruntergeladen, 
die Images und Volumes heruntergezogen. Mit dem Befehl \textbf{docker-compose up -d} erfolgt zu Beginn die Sicherstellung, dass das 
\nameref{app:docker-compose.yml} wirklich vorhanden ist, um dann gelesen und den Container für die darin definierten Dienste im Hintergrund zu starten. Der 
Parameter \textbf{-d (--detach)} bewirkt, dass die Conrainer im Hintergrund ausgeführt werden. Nach dem Start der Container erfolgt die Statusüberprüfung dieser 
mit dem Befehl \textbf{docker-compose ps}.

\subsection{Konfiguration des NGinx Reverse Proxy Managers}
\label{sec:Konfiguration des NGinx Reverse Proxy Managers}
Nachdem Authentik in einem Docker-Container läuft, erfolgt die Konfiguration des NGinx Reverse Proxy Managers:
\begin{enumerate}[label=\arabic*.]
    \item Erstellung einer Authentifizierungs-Domain (auth.example.domain) und Einstellung eines A-Records im DNS-Resolver
    \item Im NGinx Reverse Proxy Managers einen neuen Host erstellen, was im \nameref{sec:Anhang} in der \nameref{app:ProxyHostConfig} einsehbar ist
    \item private IP-Adresse des Authentik-Servers mit der in der \textbf{\nameref{app:dotenv}}-Datei eingegebenen Portnummer (80) eingeben 
    mit dem Resultat für das Beispiel: \textbf{0.0.0.0:80} - Einsicht im \ref{app:ProxyHostConfig} \nameref{app:ProxyHostConfig}
    \item im SSL-Tab des Konfigurationsfeldes, anklicken: \textit{Force SSL}, \textit{HTTP/2 Support}, \textit{HSTS Enabled} und \textit{HSTS Subdomains}
    \item im E-Mail Feld die E-Mail Adresse (admin@example.domain.de) eingeben und den Nutzungsbedingungen zustimmen
    \item Ergebnis: Zugriff auf Authentik möglich, sodass die Willkommens-Seite sichtbar wird, welche im \nameref{sec:Anhang} im Kapitel 
    \ref{app:ProxyHostConfig} \nameref{app:ProxyHostConfig}
\end{enumerate}

\subsection{Konfiguration von Authentik}
\label{sec: Konfiguration von Authentik}
Nach der Konfiguration des NGinx Reverse Proxy Managers, werden in Authenik ein Projekt und die vorhandenen User erstellt. Diese Vorgehensweise 
ist im \nameref{sec:Anhang} in der \nameref{app:AuthentikConfig} detailliert beschrieben.
Grobe Vorgehensweise:
\begin{enumerate}
    \item Einrichtung eines Projektes
    \item Erstellung von Benutzer/-innen
    \item NGinx Proxy Manager hinzufügen
    \item \nameref{sec:Einrichtung des zweiten Faktors} erfolgt in Kapitel \ref*{sec:Einrichtung des zweiten Faktors} auf der 
    Seite \pageref{sec:Einrichtung des zweiten Faktors}
\end{enumerate}


\subsection{Integration mit Cloud-Diensten}
\label{sec:Integration mit Cloud-Diensten}
Damit sich Authentik vor jeden Dienst in der gegebenen Cloud-Infrastruktur schalten kann, wird in der Host-Konfiguration im NGinx Reverse 
Proxy Manager im Bereich \textit{Advanced} die im \nameref{sec:Anhang} erwähnte \nameref{app:CustomNGinxConfig} einzufügen. Wobei zu beachten ist, 
dass bei jedem Service die Portnummer geändert wird, sodass eine Umleitung von Authelik auf diesen erfolgen kann.

\subsection{Einrichtung des zweiten Faktors}
\label{sec:Einrichtung des zweiten Faktors}
Nach dem Ergebnis aus der \nameref{tab:Nutzwertanalyse} im Kapitel \ref{sec:Auswahl einer MFA-Lösung} \nameref{sec:Auswahl einer MFA-Lösung} 
geht das \acs{TOTP}-Verfahren hervor. Ein Auszug der \nameref{sec:TOTPConfig} im \nameref{sec:Anhang} zeigt die Konfiguration des 
zweiten Faktors.
\\Ein kurze Schrittfolge zur Einrichtung diesens:
\begin{enumerate}
    \item Login bei Authentik
    \item auf \textbf{Einstellungen} gehen und \textbf{\acs*{MFA} Devices} bestätigen
    \item \textbf{Enroll} bestätigen - eine Methode auswählen:
    \begin{itemize}
        \item WebAuth Authenticator Setup Stage
        \item Static Authenticator Stage
        \item \textit{TOTP Authenticator Setup Stage} - auswählen
    \end{itemize}
   \item Logout bei Authentik
   \item erneut Login - QR-Code mit Microsoft Azure scannen
   \item 6-stelligen Code eingeben und eingeloggt
\end{enumerate}